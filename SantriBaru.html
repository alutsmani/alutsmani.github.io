<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/fixedheader/3.2.0/css/fixedHeader.bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css"
    />

    <link rel="stylesheet" href="css/style.css">

    <!-- Tag link untuk favicon -->
    <link rel="icon" href="PSB.png" type="image/x-icon" />
    <!-- Tag meta untuk gambar ketika dibagikan di media sosial -->
    <meta property="og:image" content="PSB.png" />
    
    <title>Santri Baru 1445</title>
  </head>
  <body>
    <br>
    <div class="logo-container ">
        <img src="Kop.png" alt="icon" width="120" height="120">
    </div>    
    <br>
    <div id="loading-indicator" class="loading-indicator hidden">
        <div class="spinner"></div>
        <div id="loading-count">0</div>
    </div>
    <div class="bg-utama">
        <h2>Santri Baru 1445/1446 H</h2>
        
        
        
        
        <div class="cool-box" id="KotakLogin">
            <select id="cariSantri" name="cariSantri" class="form-control mb-2" onchange="handleSearch()">
                <option value="">Santri Baru & Santri Lama</option>
                <option value="Santri Baru">Santri Baru</option>
                <option value="Santri Lama">Santri Lama</option>
            </select>
            <select id="cariBN" name="cariBN" class="form-control mb-2" onchange="handleSearch()">
                <option value="">Banin & Banat</option>
                <option value="1">Banin</option>
                <option value="2">Banat</option>
            </select>
            <div class="TTL">
                <input type="text" id="cariDaerah" class="form-control mb-2" placeholder="Daerah" onchange="handleSearch()">
                <input type="text" id="cariNoKamar" class="form-control mb-2" placeholder="No Kamar" onchange="handleSearch()">
            </div>

            <p>Filter Formal dan Status Murid</p>
            <div class="TTL">
                <select id="cariFormal" name="cariFormal" class="form-control mb-2" onchange="handleSearch()">
                    <option value="">Formal</option>
                    <option value="MTs">MTs</option>
                    <option value="SMP">SMP</option>
                    <option value="SMAI">SMAI</option>
                    <option value="STAI">STAI</option>
                    <option value="Tidak Sekolah">Tidak Sekolah</option>
                </select>
                <select id="cariStatus" name="cariStatus" class="form-control mb-2" onchange="handleSearch()">
                    <option value="">Status Murid</option>
                    <option value="Murid Baru">Murid Baru</option>
                    <option value="Murid Mutasi">Murid Mutasi</option>
                </select>
            </div>
            
            <select id="cariAdmin" name="cariAdmin" class="form-control mb-2" onchange="handleSearch()">
                <option value="">Pilih Admin</option>
                <option value="Abd Munib">Abd Munib</option>
                <option value="Feriyanto">Feriyanto</option>
                <option value="Muhammad Taufiq">Muhammad Taufiq</option>
                <option value="Ruspandi">Ruspandi</option>
                <option value="Sifaul Izet">Sifaul Izet</option>
                <option value="Nisfu Ramadhan">Nisfu Ramadhan</option>
                <option value="Mohammad Fahril Umam">Mohammad Fahril Umam</option>
                <option value="Miftahul Anam">Miftahul Anam</option>
                <option value="Syaikhul Islam">Syaikhul Islam</option>
                <option value="Muhammad Rizal">Muhammad Rizal</option>
                <option value="Muhammad Farhan Buhori">Muhammad Farhan Buhori</option>
                <option value="M Jefri">M Jefri</option>
                <option value="Baikuni">Baikuni</option>
                <option value="Uswatul Hasanah">Uswatul Hasanah</option>
                <option value="Selvi Damayanti">Selvi Damayanti</option>
                <option value="Holifatus Saadah">Holifatus Saadah</option>
                <option value="Evi Krisdayanti">Evi Krisdayanti</option>
                <option value="Ulin Nikmah Melia P">Ulin Nikmah Melia P</option>
                <option value="Intan Masruroh">Intan Masruroh</option>
                <option value="Ummu Hani">Ummu Hani</option>
                <option value="Nurdiana Kholida">Nurdiana Kholida</option>
                <option value="Inayatul Mutmainnah">Inayatul Mutmainnah</option>
                <option value="Ainur Rohmah">Ainur Rohmah</option>
                <option value="Ika Yuliana">Ika Yuliana</option>
            </select>
            

            <p>Cari Nama</p>
            <input type="text" id="nama" class="form-control mb-2" placeholder="Nama" onchange="handleSearch()">
            <p id="keterangan"> keterangan </p>
            <!-- <label id="keteranganBayar"> keterangan bayar</label> -->
        </div>

        <div id="dataContainer"></div>
        <div class="load-frame">
            <div id="loader" class="loader"></div>
        </div>
    </div>
    

     <style>
        body {
            background-image: url('bg.jpg');
            background-size:cover;

            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            background-color:rgb(181, 255, 200);
        }
        

    </style>
    
 
    
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.2.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    
    <!-- <script type="text/javascript" src="data.json"></script> -->
    

    <script>
        // Fungsi untuk mengirim data ke Google Sheets menggunakan metode doPost di Apps Script

        const debouncedSearch = debounce(handleSearch, 300);

        function handleSearch() {
            const searchSantri = document.getElementById('cariSantri').value.toLowerCase();
            const searchFormal = document.getElementById('cariFormal').value.toLowerCase();
            const searchDaerah = document.getElementById('cariDaerah').value.toLowerCase();
            const searchNo = document.getElementById('cariNoKamar').value.toLowerCase();

            const searchStatus = document.getElementById('cariStatus').value.toLowerCase();
            const searchAdmin = document.getElementById('cariAdmin').value.toLowerCase();
            const searchBN = document.getElementById('cariBN').value;
            const searchText = document.getElementById('nama').value.toLowerCase();

            const containers = document.querySelectorAll('.container');
            const filteredEntries = [];

            containers.forEach(container => {
                const title = container.querySelector('h3');
                const santri = title.querySelector('.santri').textContent.toLowerCase();
                const bn = title.querySelector('.bn').textContent;
                const daerah = title.querySelector('.daerah').textContent.toLowerCase();
                const nokamar = title.querySelector('.nokamar').textContent.toLowerCase();
                const nama = title.querySelector('.nama').textContent.toLowerCase();
                const formal = title.querySelector('.formal').textContent.toLowerCase();
                const status = title.querySelector('.status').textContent.toLowerCase();
                const admin = title.querySelector('.admin').textContent.toLowerCase();

                if (santri.includes(searchSantri) &&
                    bn.startsWith(searchBN) &&
                    daerah.startsWith(searchDaerah) &&
                    nokamar.startsWith(searchNo) &&
                    nama.includes(searchText) &&
                    formal.includes(searchFormal) &&
                    admin.includes(searchAdmin) &&
                    status.includes(searchStatus)) {
                    container.style.display = 'block';
                    filteredEntries.push(container);
                } else {
                    container.style.display = 'none';
                }
            });

            const keteranganLabel = document.getElementById('keterangan');
            const totalEntries = containers.length;
            const filteredCount = filteredEntries.length;
            keteranganLabel.textContent = `Menampilkan (${filteredCount}) dari ${totalEntries} data keseluruhan`;
        }

        document.getElementById('cariSantri').addEventListener('input', debouncedSearch);
        document.getElementById('cariFormal').addEventListener('input', debouncedSearch);
        document.getElementById('cariStatus').addEventListener('input', debouncedSearch);
        document.getElementById('nama').addEventListener('input', debouncedSearch);
        document.getElementById('cariDaerah').addEventListener('input', debouncedSearch);
        document.getElementById('cariNoKamar').addEventListener('input', debouncedSearch);

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Fungsi untuk memuat data dari Google Sheets
        function loadData() {
            // Mendapatkan nilai terpilih dari elemen select

            // URL default jika pilihan adalah "Semua"
            let url = 'https://script.google.com/macros/s/AKfycbzANtzKbwFWCvWd4UP_OrezPyzoVzosXONdax0JdncfvnTsGIbQIrZMAnKZWq62dfQGhw/exec?sh=DB';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    renderData(data.data); // Ubah dari data menjadi data.data
                    handleSearch()
                })
                .catch(error => console.error('Error fetching data:', error));
        
        }
        


        function renderData(data) {
            const dataContainer = document.getElementById('dataContainer');
            dataContainer.innerHTML = '';

            data.forEach(item => {
                const container = document.createElement('div');
                container.classList.add('container');

                const title = document.createElement('h3');

                // Membuat elemen span menggunakan fungsi createSpan
                const namaSpan = createSpan('nama', item.Nama);
                const idsSpan = createSpan('bn', item.IDS);
                const DaerahSpan = createSpan('daerah', item.Daerah);
                const NoSpan = createSpan('nokamar', item.NoKamar);
                const formalSpan = createSpan('formal', item.MelanjutkanKe);
                const statusSpan = createSpan('status', item.StatusPendaftar);
                const santriSpan = createSpan('santri', item.Status);
                const adminSpan = createSpan('admin', item.PenanggungJawab);

                // Menambahkan span ke dalam judul
                title.appendChild(namaSpan);
                title.appendChild(idsSpan);
                title.appendChild(DaerahSpan);
                title.appendChild(NoSpan);
                title.appendChild(formalSpan);
                title.appendChild(statusSpan);
                title.appendChild(santriSpan);
                title.appendChild(adminSpan);

                title.addEventListener('click', function() {
                    const details = container.querySelector('.details');
                    details.style.display = details.style.display === 'block' ? 'none' : 'block';
                });

                const details = document.createElement('div');
                details.classList.add('details');

                // Buat tabel untuk menyusun data dalam dua kolom
                const table = document.createElement('table');
                const tbody = document.createElement('tbody');

                // Menambahkan baris data
                addDataRow(tbody, 'NIK', item.NIK);
                addDataRow(tbody, 'IDS', item.IDS);
                addDataRow(tbody, 'Domisili', item.Daerah + "." + item.NoKamar);
                addDataRow(tbody, 'TTL', item.TempatLahir + ", " + formatDate(item.TanggalLahir));
                addDataRow(tbody, 'Diniyah', item.Diniyah);
                addDataRow(tbody, 'Formal', item.Formal);
                addDataRow(tbody, 'Ayah', item.Ayah);
                addDataRow(tbody, 'Ibu', item.Ibu);
                addDataRow(tbody, 'Alamat', `${item.Dusun} ${item.RT}/${item.RW}, ${item.Desa}, ${item.Kecamatan}, ${item.Kabupaten}`);
                addDataRow(tbody, 'Tanggal daftar', item.Hijriyah + " H. - " + formatDate(item.Masehi) + " M.");
                addDataRow(tbody, 'Admin', item.PenanggungJawab);
                addDataRow(tbody, 'Pembayaran', item.Total.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                addDataRow(tbody, 'Pesantren', item.Bayar_Pesantren.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                addDataRow(tbody, 'Madrasah', item.Bayar_Madrasah.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                addDataRow(tbody, 'Formal', item.Bayar_Formal.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }));
                addDataRow(tbody, '-----------------------', '-----------------------------------------------');

                table.appendChild(tbody);
                details.appendChild(table);

                // Menambahkan checkbox untuk KetNailulMurod, KetKalender, KetKartuSantri, dan KetTataTertib
                const checkboxContainer = document.createElement('div');
                checkboxContainer.classList.add('checkbox-container');

                addCheckbox(checkboxContainer, 'KetNailulMurod', 'Nailul Murod', item.KetNailulMurod, item.NIK, item.IDS, item.NailulMurod);
                addCheckbox(checkboxContainer, 'KetKalender', 'Kalender', item.KetKalender, item.NIK, item.IDS, item.Kalender);
                addCheckbox(checkboxContainer, 'KetTataTertib', 'Tata Tertib', item.KetTataTertib, item.NIK, item.IDS, item.TataTertib);
                addCheckbox(checkboxContainer, 'KetKartuSantri', 'Kartu Santri', item.KetKartuSantri, item.NIK, item.IDS, item.KartuSantri);
                addCheckbox(checkboxContainer, 'KetSeragamPondok', 'Sarung / Gamis', item.KetSeragamPondok, item.NIK, item.IDS, item.SeragamPondok);

                details.appendChild(checkboxContainer);

                container.appendChild(title);
                container.appendChild(details);
                dataContainer.appendChild(container);
            });

            const loader = document.getElementById('loader');
            loader.classList.remove('visible');
            loader.classList.add('hidden');
        }




        function queueCheckboxStatus(nik, ids, name, status) {
            const existingIndex = checkboxUpdateQueue.findIndex(item => item.nik === nik && item.ids === ids && item.name === name);
            if (existingIndex >= 0) {
                checkboxUpdateQueue[existingIndex].status = status;
            } else {
                checkboxUpdateQueue.push({ nik, ids, name, status });
                totalCheckboxes += 1;
                updateLoadingIndicator();
            }

            if (debounceTimeouts[`${nik}-${ids}`]) {
                clearTimeout(debounceTimeouts[`${nik}-${ids}`]);
            }

            debounceTimeouts[`${nik}-${ids}`] = setTimeout(() => {
                processCheckboxQueue(nik, ids);
                delete debounceTimeouts[`${nik}-${ids}`];
            }, 1000);
        }

        function processCheckboxQueue(nik, ids) {
            const updates = checkboxUpdateQueue.filter(item => item.nik === nik && item.ids === ids);
            checkboxUpdateQueue = checkboxUpdateQueue.filter(item => !(item.nik === nik && item.ids === ids));

            if (updates.length > 0) {
                const header = updates.map(update => `${update.name}=${encodeURIComponent(update.status)}`).join('&');
                const data = `NIK=${encodeURIComponent(nik)}&IDS=${encodeURIComponent(ids)}&${header}`;
                postCheckboxStatus(data).then(() => {
                    totalCheckboxes -= updates.length;
                    updateLoadingIndicator();
                });
            }
        }

        // Fungsi untuk memposting status checkbox
        function postCheckboxStatus(header) {
            return postJSON(header).then(() => {
                decrementLoadingCount();
            });
        }

        // Fungsi untuk mengupdate indikator loading
        function updateLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            const count = document.getElementById('loading-count');
            const pendingCount = totalCheckboxes;

            if (pendingCount > 0) {
                indicator.classList.remove('hidden');
                count.textContent = pendingCount;
            } else {
                indicator.classList.add('hidden');
            }
        }

        // Fungsi untuk mengurangi hitungan loading
        function decrementLoadingCount() {
            const count = document.getElementById('loading-count');
            let currentCount = parseInt(count.textContent, 10);

            if (currentCount > 0) {
                currentCount -= 1;
                count.textContent = currentCount;

                if (currentCount === 0) {
                    const indicator = document.getElementById('loading-indicator');
                    indicator.classList.add('hidden');
                }
            }
        }

        // Fungsi untuk memformat tanggal
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Fungsi untuk mengirimkan permintaan POST
        async function postJSON(header) {
            const url = "https://script.google.com/macros/s/AKfycbzANtzKbwFWCvWd4UP_OrezPyzoVzosXONdax0JdncfvnTsGIbQIrZMAnKZWq62dfQGhw/exec?action=UpdateData";
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: header
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                return await response.text();
            } catch (error) {
                throw new Error('There has been a problem with your fetch operation:', error);
            }
        }

        // Memanggil fungsi loadData() saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });


    </script>

    <script src="js/script.js"></script>

  </body>
</html>

